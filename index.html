<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Insurance Agents - Live Search</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0062FF;
            --success: #00D084;
            --warning: #FFB800;
            --error: #FF4858;
            --dark: #0A1931;
            --gray: #68768C;
            --light-gray: #F5F7FA;
            --border: #E4E9F0;
            --bg: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light-gray);
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 1.25rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .agent-status-header {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .header-search-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .header-search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .header-search-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-pill {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-pill.searching {
            background: #E3F2FF;
            color: var(--primary);
        }

        .status-pill.ready {
            background: var(--light-gray);
            color: var(--gray);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Provider Showcase - shown before search starts */
        .provider-showcase {
            margin-top: 1rem;
        }

        .provider-showcase-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .provider-chip {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s;
            cursor: default;
        }

        .provider-chip:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 98, 255, 0.1);
            transform: translateY(-2px);
        }

        .provider-chip-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .provider-chip-url {
            font-size: 0.7rem;
            color: var(--gray);
            font-family: 'Monaco', monospace;
        }

        .provider-showcase.hidden {
            display: none;
        }

        /* Main Layout */
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 340px 1fr 320px;
            gap: 1.5rem;
            padding: 2rem;
            min-height: calc(100vh - 100px);
        }

        /* LEFT: Questionnaire */
        .questionnaire-sidebar {
            background: var(--bg);
            border-radius: 12px;
            padding: 2rem;
            height: fit-content;
            position: sticky;
            top: 120px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .sidebar-subtitle {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 2rem;
        }

        .form-section {
            margin-bottom: 1.5rem;
        }

        .section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 0.75rem;
            letter-spacing: 0.5px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: var(--bg);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 98, 255, 0.1);
        }

        input.filled {
            border-color: var(--success);
            background: #F0FDF4;
        }

        .search-trigger {
            margin-top: 2rem;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            width: 100%;
        }

        .search-trigger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .search-trigger:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auto-search-notice {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #FFF7ED;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #C2410C;
            text-align: center;
            border: 1px solid #FFEDD5;
        }

        /* CENTER: Results Grid */
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .results-header {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .results-subtitle {
            font-size: 0.95rem;
            color: var(--gray);
        }

        .provider-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .provider-card {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .provider-card.searching {
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(0, 98, 255, 0.15);
        }

        .provider-card.completed {
            border-color: var(--success);
        }

        .provider-card.error {
            border-color: var(--error);
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .provider-info {
            flex: 1;
        }

        .provider-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .provider-url {
            font-size: 0.75rem;
            color: var(--gray);
            font-family: 'Monaco', monospace;
        }

        .provider-price {
            text-align: right;
        }

        .price-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .price-period {
            font-size: 0.875rem;
            color: var(--gray);
            font-weight: 400;
        }

        /* Agent Activity Visualization */
        .agent-activity {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 8px;
        }

        .activity-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .activity-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--gray);
            opacity: 0.5;
        }

        .activity-step.active {
            color: var(--primary);
            opacity: 1;
            font-weight: 500;
        }

        .activity-step.completed {
            color: var(--success);
            opacity: 1;
        }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .step-icon.active {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0%, 100% {
                box-shadow: 0 0 0 0 currentColor;
            }
            50% {
                box-shadow: 0 0 0 4px rgba(0, 98, 255, 0.2);
            }
        }

        .progress-bar {
            height: 4px;
            background: #E4E9F0;
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #667eea);
            transition: width 0.3s ease;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* RIGHT: API Logs */
        .logs-sidebar {
            position: sticky;
            top: 120px;
            height: fit-content;
            max-height: calc(100vh - 160px);
        }

        .logs-card {
            background: var(--dark);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .logs-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logs-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #10B981;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logs-container {
            flex: 1;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.75rem;
            line-height: 1.6;
            max-height: calc(100vh - 280px);
        }

        .log-entry {
            margin-bottom: 0.5rem;
            display: flex;
            gap: 0.5rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-time {
            color: #6B7280;
            flex-shrink: 0;
        }

        .log-message {
            color: #D1D5DB;
        }

        .log-entry.info .log-message { color: #60A5FA; }
        .log-entry.success .log-message { color: #10B981; }
        .log-entry.warning .log-message { color: #F59E0B; }
        .log-entry.error .log-message { color: #EF4444; }
        .log-entry.agent .log-message { color: #A78BFA; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-description {
            font-size: 0.95rem;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 300px 1fr 280px;
            }
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .questionnaire-sidebar,
            .logs-sidebar {
                position: static;
            }
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span>ü§ñ</span>
                <span>AI Insurance Agents</span>
            </div>
            <div class="agent-status-header">
                <div class="status-pill" id="headerStatus">
                    <span>Ready to search</span>
                </div>
                <button type="button" class="header-search-button" id="headerSearchBtn">
                    üöÄ Search All Providers
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- LEFT: Questionnaire -->
        <div class="questionnaire-sidebar">
            <div class="sidebar-title">Quote Search</div>
            <div class="sidebar-subtitle">Fill in your details to find the best rates</div>

            <form id="quoteForm">
                <div class="form-section">
                    <div class="section-label">Driver Info</div>
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth</label>
                        <input type="date" id="dateOfBirth" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone" placeholder="(XXX) XXX-XXXX" required>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-label">Vehicle</div>
                    <div class="form-group">
                        <label>VIN</label>
                        <input type="text" id="vin" maxlength="17" required>
                    </div>
                    <div class="form-group">
                        <label>Year</label>
                        <input type="number" id="year" min="1990" max="2026" required>
                    </div>
                    <div class="form-group">
                        <label>Make</label>
                        <input type="text" id="make" required>
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <input type="text" id="model" required>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-label">Address</div>
                    <div class="form-group">
                        <label>Street</label>
                        <input type="text" id="address" required>
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="city" required>
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="state" maxlength="2" value="TX" required>
                    </div>
                    <div class="form-group">
                        <label>ZIP</label>
                        <input type="text" id="zipcode" maxlength="5" required>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-label">Policy</div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="policyStartDate" required>
                    </div>
                </div>
            </form>
        </div>

        <!-- CENTER: Results -->
        <div class="results-container">
            <div class="results-header">
                <div class="results-title">Live Quote Results</div>
                <div class="results-subtitle" id="resultsSubtitle">4 providers will be reached out for quotes</div>
            </div>

            <div class="provider-grid" id="providerGrid">
                <!-- Provider showcase shown before search starts -->
                <div class="provider-showcase" id="providerShowcase">
                    <div class="provider-showcase-grid">
                        <div class="provider-chip">
                            <div class="provider-chip-name">GEICO</div>
                            <div class="provider-chip-url">geico.com</div>
                        </div>
                        <div class="provider-chip">
                            <div class="provider-chip-name">Progressive</div>
                            <div class="provider-chip-url">progressive.com</div>
                        </div>
                        <div class="provider-chip">
                            <div class="provider-chip-name">State Farm</div>
                            <div class="provider-chip-url">statefarm.com</div>
                        </div>
                        <div class="provider-chip">
                            <div class="provider-chip-name">American Family</div>
                            <div class="provider-chip-url">amfam.com</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: API Logs -->
        <div class="logs-sidebar">
            <div class="logs-card">
                <div class="logs-header">
                    <span class="logs-title">‚ö° Live Agent Activity</span>
                </div>
                <div class="logs-container" id="logsContainer">
                    <div class="log-entry info">
                        <span class="log-time">[SYSTEM]</span>
                        <span class="log-message">AI agents ready and waiting...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect API base URL (works on localhost and Vercel)
        const API_BASE = window.location.origin;
        let eventSource = null;
        let currentRunId = null;

        // Working insurance providers - verified to return quotes
        const PROVIDERS = [
            { id: 'geico', name: 'GEICO', url: 'geico.com' },
            { id: 'progressive', name: 'Progressive', url: 'progressive.com' },
            { id: 'statefarm', name: 'State Farm', url: 'statefarm.com' },
            { id: 'americanfamily', name: 'American Family', url: 'amfam.com' }
        ];

        // Load sample data
        async function loadSampleData() {
            try {
                const response = await fetch(`${API_BASE}/sample-data`);
                const data = await response.json();

                document.getElementById('firstName').value = data.driver.firstName || '';
                document.getElementById('lastName').value = data.driver.lastName || '';

                if (data.driver.dateOfBirth) {
                    const [month, day, year] = data.driver.dateOfBirth.split('/');
                    document.getElementById('dateOfBirth').value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }

                document.getElementById('phone').value = data.driver.phone || '';
                document.getElementById('vin').value = data.vehicle.vin || '';
                document.getElementById('year').value = data.vehicle.year || '';
                document.getElementById('make').value = data.vehicle.make || '';
                document.getElementById('model').value = data.vehicle.model || '';
                document.getElementById('address').value = data.address.street || '';
                document.getElementById('city').value = data.address.city || '';
                document.getElementById('state').value = data.address.state || '';
                document.getElementById('zipcode').value = data.address.zipcode || '';
                document.getElementById('policyStartDate').value = data.policy.startDate || '';

                addLog('‚úì Sample data loaded', 'success');
                markFieldsAsFilled();
            } catch (error) {
                addLog('‚ö† Could not load sample data', 'warning');
            }
        }

        function markFieldsAsFilled() {
            document.querySelectorAll('input').forEach(input => {
                if (input.value) {
                    input.classList.add('filled');
                }
            });
        }

        // Add visual feedback as user types
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', (e) => {
                if (e.target.value) {
                    e.target.classList.add('filled');
                } else {
                    e.target.classList.remove('filled');
                }
            });
        });

        // Form submission - trigger search when header button is clicked
        document.getElementById('headerSearchBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            // Validate form first
            if (document.getElementById('quoteForm').checkValidity()) {
                startQuoteSearch();
            } else {
                document.getElementById('quoteForm').reportValidity();
            }
        });

        // Also allow form submission via Enter key
        document.getElementById('quoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            startQuoteSearch();
        });

        // Reconnection logic for resilient SSE streaming
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 50; // Increased from 10 - connections close every 4 minutes by design
        let pollingFallbackInterval = null;
        let isCompleted = false;

        function connectToStream(runId, streamUrl) {
            if (isCompleted) return;

            const attemptMsg = reconnectAttempts > 0 ? ` (attempt ${reconnectAttempts + 1})` : '';
            addLog(`‚Üí Connecting to stream${attemptMsg}...`, 'info');

            eventSource = new EventSource(`${API_BASE}${streamUrl}`);

            eventSource.onopen = () => {
                if (reconnectAttempts > 0) {
                    addLog('‚úì Reconnected successfully!', 'success');
                }
                reconnectAttempts = 0; // Reset on successful connection
            };

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'activity' && data.activity) {
                    addLog(`ü§ñ ${data.provider}: ${data.activity}`, 'agent');
                    updateProviderActivity(data.providerId, data.activity, data.minoRunId);
                }

                if (data.type === 'progress' || data.type === 'complete') {
                    updateProviderCards(data.aggregation);

                    // Log Mino run IDs when available
                    if (data.aggregation && data.aggregation.quotes) {
                        data.aggregation.quotes.forEach(quote => {
                            if (quote.currentStepMinoRunId && !window[`logged_${quote.providerId}_${quote.currentStepMinoRunId}`]) {
                                addLog(`‚Üí ${quote.provider} Mino API call: ${quote.currentStepMinoRunId.substring(0, 8)}...`, 'info');
                                window[`logged_${quote.providerId}_${quote.currentStepMinoRunId}`] = true;
                            }
                        });
                    }
                }

                if (data.type === 'complete') {
                    isCompleted = true;
                    eventSource.close();
                    if (pollingFallbackInterval) {
                        clearInterval(pollingFallbackInterval);
                    }
                    document.getElementById('headerSearchBtn').disabled = false;
                    document.getElementById('headerSearchBtn').textContent = 'üîÑ Search Again';
                    updateHeaderStatus('ready');
                    addLog('‚úì All agents completed their tasks', 'success');
                }
            };

            eventSource.onerror = (error) => {
                console.error('SSE Connection Error:', error);
                console.error('EventSource readyState:', eventSource.readyState);

                eventSource.close();

                if (isCompleted) {
                    return; // Don't reconnect if already completed
                }

                reconnectAttempts++;

                if (reconnectAttempts <= MAX_RECONNECT_ATTEMPTS) {
                    // Shorter delays since connections close every 4 min by design
                    // 1s, 2s, 3s, 5s, 5s, 5s... (max 5 seconds)
                    const delay = Math.min(reconnectAttempts * 1000, 5000);
                    addLog(`‚ö† Connection lost. Reconnecting in ${delay/1000}s...`, 'warning');

                    setTimeout(() => {
                        connectToStream(runId, streamUrl);
                    }, delay);
                } else {
                    // Switch to polling fallback after 50 attempts
                    addLog('‚Üí Switching to polling mode...', 'warning');
                    startPollingFallback(runId);
                }
            };
        }

        // Fallback polling mechanism if SSE keeps failing
        async function startPollingFallback(runId) {
            if (pollingFallbackInterval) return; // Already polling

            addLog('‚Üí Using HTTP polling for updates', 'info');

            pollingFallbackInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/quotes/${runId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();

                    // Update provider cards with current progress (not just final results)
                    if (data.quotes) {
                        updateProviderCards(data);

                        // Check if all completed
                        if (data.status === 'completed') {
                            isCompleted = true;
                            clearInterval(pollingFallbackInterval);
                            document.getElementById('headerSearchBtn').disabled = false;
                            document.getElementById('headerSearchBtn').textContent = 'üîÑ Search Again';
                            updateHeaderStatus('ready');
                            addLog('‚úì All results received via polling', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    // Continue polling even on error
                }
            }, 2000); // Poll every 2 seconds
        }

        async function startQuoteSearch() {
            // Reset state
            isCompleted = false;
            reconnectAttempts = 0;
            if (pollingFallbackInterval) {
                clearInterval(pollingFallbackInterval);
                pollingFallbackInterval = null;
            }
            const formData = {
                vin: document.getElementById('vin').value,
                employmentStatus: 'EMPLOYED',
                educationLevel: 'BACHELORS',
                phone: formatPhone(document.getElementById('phone').value),
                policyStartDate: document.getElementById('policyStartDate').value,
                mailingAddress: document.getElementById('address').value,
                isMailingSameAsGaraging: true
            };

            try {
                document.getElementById('headerSearchBtn').disabled = true;
                document.getElementById('headerSearchBtn').textContent = 'üîç Searching...';
                updateHeaderStatus('searching');

                // Clear previous results and hide provider showcase
                document.getElementById('providerShowcase')?.classList.add('hidden');
                document.getElementById('providerGrid').innerHTML = '';

                // Create provider cards immediately
                PROVIDERS.forEach(provider => {
                    createProviderCard(provider);
                });

                addLog('‚Üí Dispatching AI agents to ' + PROVIDERS.length + ' providers', 'info');
                addLog('‚Üí Agents will autonomously fill forms and extract quotes', 'agent');

                // Start quote request
                addLog('‚Üí Sending request to API...', 'info');
                const response = await fetch(`${API_BASE}/api/quotes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    addLog(`‚úó API returned error: ${response.status} ${response.statusText}`, 'error');
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const responseData = await response.json();
                console.log('API Response:', responseData);

                const { runId, streamUrl } = responseData;
                currentRunId = runId;

                addLog(`‚úì Quote request ID: ${runId}`, 'success');
                addLog('‚Üí Opening real-time stream...', 'info');

                // Connect to SSE with automatic reconnection
                connectToStream(runId, streamUrl);

            } catch (error) {
                addLog('‚úó Search failed: ' + error.message, 'error');
                document.getElementById('headerSearchBtn').disabled = false;
                document.getElementById('headerSearchBtn').textContent = 'üöÄ Search All Providers';
                updateHeaderStatus('ready');
            }
        }

        function createProviderCard(provider) {
            const card = document.createElement('div');
            card.className = 'provider-card searching';
            card.id = `provider-${provider.id}`;

            card.innerHTML = `
                <div class="provider-header">
                    <div class="provider-info">
                        <div class="provider-name">${provider.name}</div>
                        <div class="provider-url">${provider.url}</div>
                    </div>
                    <div class="provider-price" id="price-${provider.id}">
                        <div class="price-label">Searching...</div>
                    </div>
                </div>
                <div class="agent-activity">
                    <div id="activity-text-${provider.id}" style="font-size: 0.875rem; color: var(--primary); font-weight: 500; margin-bottom: 0.75rem; min-height: 20px;">
                        Launching browser...
                    </div>
                    <div class="activity-steps" id="steps-${provider.id}">
                        <div class="activity-step active">
                            <div class="step-icon active">1</div>
                            <span>Opening browser...</span>
                        </div>
                        <div class="activity-step">
                            <div class="step-icon">2</div>
                            <span>Navigating to site...</span>
                        </div>
                        <div class="activity-step">
                            <div class="step-icon">3</div>
                            <span>Filling form fields...</span>
                        </div>
                        <div class="activity-step">
                            <div class="step-icon">4</div>
                            <span>Submitting & extracting quote...</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-${provider.id}" style="width: 10%"></div>
                    </div>
                </div>
            `;

            document.getElementById('providerGrid').appendChild(card);
            addLog(`ü§ñ Agent launched for ${provider.name}`, 'agent');
        }

        function updateProviderCards(aggregation) {
            aggregation.quotes.forEach(quote => {
                const card = document.getElementById(`provider-${quote.providerId}`);
                if (!card) return;

                // Update card status
                card.className = 'provider-card';
                if (quote.status === 'in_progress') {
                    card.classList.add('searching');
                } else if (quote.status === 'completed') {
                    card.classList.add('completed');
                } else if (quote.status === 'failed') {
                    card.classList.add('error');
                }

                // Update progress
                const progressBar = document.getElementById(`progress-${quote.providerId}`);
                if (progressBar) {
                    progressBar.style.width = `${quote.progress}%`;
                }

                // Update activity text
                const activityText = document.getElementById(`activity-text-${quote.providerId}`);
                if (activityText) {
                    if (quote.activity) {
                        // Use activity from quote if available
                        activityText.textContent = quote.activity;
                        activityText.style.animation = 'slideIn 0.3s ease';
                    } else if (quote.status === 'in_progress') {
                        // Fallback to progress-based activity if no activity text
                        const progressActivities = {
                            0: 'Launching browser...',
                            25: 'Navigating to site...',
                            50: 'Filling form fields...',
                            75: 'Extracting quote...',
                            100: 'Processing results...'
                        };
                        // Find the closest progress milestone
                        const milestones = [0, 25, 50, 75, 100];
                        const closest = milestones.reduce((prev, curr) => 
                            Math.abs(curr - quote.progress) < Math.abs(prev - quote.progress) ? curr : prev
                        );
                        activityText.textContent = progressActivities[closest] || 'Processing...';
                    }
                }

                // Update steps
                const stepsContainer = document.getElementById(`steps-${quote.providerId}`);
                if (stepsContainer && quote.progress > 0) {
                    const steps = stepsContainer.querySelectorAll('.activity-step');
                    steps.forEach((step, index) => {
                        const stepProgress = ((index + 1) / steps.length) * 100;
                        step.classList.remove('active', 'completed');

                        if (quote.progress > stepProgress) {
                            step.classList.add('completed');
                        } else if (Math.abs(quote.progress - stepProgress) < 30) {
                            step.classList.add('active');
                        }
                    });
                }

                // Update price
                const priceContainer = document.getElementById(`price-${quote.providerId}`);
                if (priceContainer) {
                    if (quote.finalQuote) {
                        priceContainer.innerHTML = `
                            <div class="price-label">Monthly Premium</div>
                            <div class="price-value">$${quote.finalQuote}<span class="price-period">/mo</span></div>
                        `;
                        addLog(`‚úì ${quote.provider}: $${quote.finalQuote}/mo`, 'success');
                    } else if (quote.estimatedQuote) {
                        priceContainer.innerHTML = `
                            <div class="price-label">Estimated</div>
                            <div class="price-value" style="font-size: 1.5rem;">$${quote.estimatedQuote.min}-${quote.estimatedQuote.max}<span class="price-period">/mo</span></div>
                        `;
                    } else if (quote.error) {
                        priceContainer.innerHTML = `
                            <div class="price-label" style="color: var(--error);">Failed</div>
                        `;
                        addLog(`‚úó ${quote.provider}: ${quote.error}`, 'error');
                    } else if (quote.status === 'completed' && quote.details) {
                        // Agent completed but couldn't extract quote (common with real insurance sites)
                        priceContainer.innerHTML = `
                            <div class="price-label" style="color: var(--warning);">‚ö†Ô∏è Agent Contact Required</div>
                            <div class="price-value" style="font-size: 0.9rem; color: var(--gray); line-height: 1.4;">${quote.details.substring(0, 120)}${quote.details.length > 120 ? '...' : ''}</div>
                        `;
                        addLog(`‚ö†Ô∏è ${quote.provider}: ${quote.details}`, 'warning');
                    } else if (quote.status === 'completed') {
                        // Completed but no data extracted
                        priceContainer.innerHTML = `
                            <div class="price-label" style="color: var(--warning);">‚ö†Ô∏è No Quote Available</div>
                            <div class="price-value" style="font-size: 0.9rem; color: var(--gray);">Form completed but quote requires agent contact</div>
                        `;
                        addLog(`‚ö†Ô∏è ${quote.provider}: Form completed, quote requires agent contact`, 'warning');
                    } else if (quote.status === 'in_progress') {
                        const statusTexts = {
                            25: 'Connecting...',
                            50: 'Filling form...',
                            75: 'Extracting quote...'
                        };
                        const text = statusTexts[quote.progress] || 'Processing...';
                        priceContainer.innerHTML = `<div class="price-label">${text}</div>`;
                    }
                }

                // Update subtitle
                const completed = aggregation.quotes.filter(q => q.status === 'completed' || q.status === 'failed').length;
                document.getElementById('resultsSubtitle').textContent =
                    `${completed} of ${aggregation.totalProviders} providers responded`;
            });
        }

        function addLog(message, type = 'info') {
            const container = document.getElementById('logsContainer');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });

            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-message">${message}</span>
            `;

            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateProviderActivity(providerId, activity, minoRunId) {
            const activityText = document.getElementById(`activity-text-${providerId}`);
            if (activityText) {
                let displayText = activity;
                if (minoRunId) {
                    displayText += ` [Mino: ${minoRunId.substring(0, 8)}...]`;
                }
                activityText.textContent = displayText;
                activityText.style.animation = 'slideIn 0.3s ease';
            }
        }

        function updateHeaderStatus(status) {
            const headerStatus = document.getElementById('headerStatus');
            if (status === 'searching') {
                headerStatus.className = 'status-pill searching';
                headerStatus.innerHTML = `
                    <div class="spinner"></div>
                    <span>AI agents searching...</span>
                `;
            } else {
                headerStatus.className = 'status-pill ready';
                headerStatus.innerHTML = `<span>Ready to search</span>`;
            }
        }

        function formatPhone(phone) {
            const digits = phone.replace(/\D/g, '').slice(0, 10);
            if (digits.length === 10) {
                return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
            }
            return phone;
        }

        // Initialize
        loadSampleData();
    </script>
</body>
</html>
